<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Todo App | Ultimate Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root.light {
            --bg-body-start: #f1f5f9; --bg-body-end: #e2e8f0;
            --bg-card: rgba(255, 255, 255, 0.7);
            --text-primary: #0f172a; --text-secondary: #475569;
            --border-color: #cbd5e1; --input-bg: rgba(255, 255, 255, 0.9);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --blob-color-1: #a78bfa; --blob-color-2: #7dd3fc;
        }
        :root.dark {
            --bg-body-start: #0f172a; --bg-body-end: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.6);
            --text-primary: #f8fafc; --text-secondary: #94a3b8;
            --border-color: #334155; --input-bg: rgba(51, 65, 85, 0.8);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --blob-color-1: #7c3aed; --blob-color-2: #0ea5e9;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body-end);
            background: linear-gradient(135deg, var(--bg-body-start), var(--bg-body-end));
            transition: background 0.5s ease;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            position: relative;
        }
        .animated-gradient { background-size: 200% 200%; animation: gradient-animation 15s ease infinite; }
        @keyframes gradient-animation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass-card {
            background: var(--bg-card); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color); box-shadow: 0 8px 32px 0 var(--shadow-color);
            transition: all 0.3s ease;
        }
        .input-style { background-color: var(--input-bg); border-color: var(--border-color); color: var(--text-primary); }
        .input-style::placeholder { color: var(--text-secondary); }
        .input-style:focus { --tw-ring-color: #6366f1; }
        .task-completed .task-title { text-decoration: line-through; color: var(--text-secondary); }
        .task-completed .task-description { text-decoration: line-through; color: var(--text-secondary); opacity: 0.7; }
        .date-pill { display: inline-flex; align-items: center; padding: 0.375rem 1rem; border-radius: 9999px; font-size: 0.9rem; font-weight: 600; }
        .date-past { background-color: #fee2e2; color: #b91c1c; } .dark .date-past { background-color: #5f1818; color: #fecaca; }
        .date-today { background-color: #dbeafe; color: #1e40af; } .dark .date-today { background-color: #1e3a8a; color: #bfdbfe; }
        .date-future { background-color: #d1fae5; color: #065f46; } .dark .date-future { background-color: #064e3b; color: #a7f3d0; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; } .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; } .dark ::-webkit-scrollbar-thumb:hover { background: #334155; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .task-item { animation: slideIn 0.5s ease forwards; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        
        /* Live Background Blobs */
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            will-change: transform;
            transition: transform 0.5s ease-out;
        }
        .blob-1 {
            width: 400px; height: 400px;
            top: -150px; left: -150px;
            background-color: var(--blob-color-1);
        }
        .blob-2 {
            width: 500px; height: 500px;
            bottom: -200px; right: -200px;
            background-color: var(--blob-color-2);
        }
    </style>
</head>
<body class="animated-gradient min-h-screen flex items-center justify-center p-4">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <button id="theme-toggle" class="fixed top-6 right-6 z-50 p-3 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
        <svg id="theme-icon-light" class="h-7 w-7 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
        <svg id="theme-icon-dark" class="h-7 w-7 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
    </button>
    
    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8 relative z-10">
        <header class="text-center mb-16">
            <h1 class="text-8xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-500 to-purple-500">TaskFlow</h1>
            <p style="color: var(--text-secondary);" class="mt-4 text-2xl">Turn your chaos into clarity.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
            <!-- Left Sidebar for Controls -->
            <aside class="md:col-span-1 space-y-10">
                <div class="glass-card rounded-2xl p-9">
                    <h2 class="text-3xl font-bold mb-6" style="color: var(--text-primary);">Add Task</h2>
                    <form id="addTaskForm" class="space-y-6">
                        <input type="text" id="title" required class="input-style w-full px-5 py-4 text-lg rounded-lg" placeholder="Task Title">
                        <textarea id="description" rows="3" class="input-style w-full px-5 py-4 text-lg rounded-lg" placeholder="Description..."></textarea>
                        <input type="datetime-local" id="due_date" class="input-style w-full px-5 py-4 text-lg rounded-lg">
                        <button type="submit" class="w-full py-4 px-6 text-lg rounded-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">
                            Add Task
                        </button>
                    </form>
                </div>

                <div class="glass-card rounded-2xl p-9">
                    <h3 class="text-3xl font-bold mb-6" style="color: var(--text-primary);">Controls</h3>
                    <div class="space-y-6">
                        <div>
                            <label class="text-lg font-medium" style="color: var(--text-secondary);">Filter</label>
                            <div id="filter-buttons" class="flex space-x-3 mt-3">
                                <button data-filter="all" class="filter-btn flex-1 px-4 py-3 text-lg rounded-lg transition">All</button>
                                <button data-filter="active" class="filter-btn flex-1 px-4 py-3 text-lg rounded-lg transition">Active</button>
                                <button data-filter="completed" class="filter-btn flex-1 px-4 py-3 text-lg rounded-lg transition">Completed</button>
                            </div>
                        </div>
                        <div>
                            <label for="sort-by" class="text-lg font-medium" style="color: var(--text-secondary);">Sort By</label>
                            <select id="sort-by" class="input-style w-full mt-3 px-4 py-3 text-lg rounded-lg">
                                <option value="created_at">Date Created</option>
                                <option value="due_date">Due Date</option>
                            </select>
                        </div>
                        <div>
                           <h4 class="text-lg font-medium" style="color: var(--text-secondary);">Stats</h4>
                           <div class="mt-3 text-lg space-y-2" style="color: var(--text-primary);">
                               <p>Active Tasks: <span id="active-count" class="font-bold">0</span></p>
                               <p>Completed: <span id="completed-count" class="font-bold">0</span></p>
                           </div>
                        </div>
                         <button id="clear-completed-btn" class="w-full py-3 px-5 mt-6 rounded-lg text-lg font-medium text-red-700 bg-red-100 hover:bg-red-200 dark:bg-red-900/50 dark:text-red-300 dark:hover:bg-red-900/80 transition disabled:opacity-50 disabled:cursor-not-allowed">
                            Clear Completed
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Right side for Task List -->
            <main class="md:col-span-2">
                <div id="taskList" class="space-y-6">
                    <div id="loading" class="text-center py-12" style="color: var(--text-secondary);"><p class="text-xl">Loading tasks...</p></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals (Edit & Confirmation) -->
    <div id="editModal" class="modal fixed inset-0 bg-black bg-opacity-70 h-full w-full z-50 transition-opacity duration-300 opacity-0 invisible">
        <div class="relative top-20 mx-auto w-full max-w-lg modal-content transform scale-95">
           <div class="glass-card rounded-2xl m-4"><div class="p-9">
                <h3 class="text-3xl font-bold text-center" style="color: var(--text-primary);">Edit Task</h3>
                <form id="editTaskForm" class="mt-8 space-y-6">
                    <input type="hidden" id="edit-id">
                    <input type="hidden" id="edit-completed-status">
                    <input type="text" id="edit-title" required class="input-style w-full px-5 py-4 text-lg rounded-lg" placeholder="Task Title">
                    <textarea id="edit-description" rows="3" class="input-style w-full px-5 py-4 text-lg rounded-lg" placeholder="Description..."></textarea>
                    <input type="datetime-local" id="edit-due_date" class="input-style w-full px-5 py-4 text-lg rounded-lg">
                    <div class="pt-6 flex justify-end space-x-4">
                        <button type="button" class="cancel-btn px-8 py-4 text-lg rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500">Cancel</button>
                        <button type="submit" class="px-8 py-4 text-lg rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Save Changes</button>
                    </div>
                </form>
           </div></div>
        </div>
    </div>

    <div id="confirmModal" class="modal fixed inset-0 bg-black bg-opacity-70 h-full w-full z-50 transition-opacity duration-300 opacity-0 invisible">
        <div class="relative top-20 mx-auto w-full max-w-lg modal-content transform scale-95">
           <div class="glass-card rounded-2xl m-4"><div class="p-9 text-center">
                <svg class="mx-auto mb-6 h-16 w-16 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                <h3 id="confirm-title" class="text-2xl font-bold" style="color: var(--text-primary);">Are you sure?</h3>
                <p id="confirm-message" class="mt-3 text-lg" style="color: var(--text-secondary);">This action cannot be undone.</p>
                <div class="mt-8 flex justify-center space-x-4">
                    <button class="cancel-btn px-8 py-4 text-lg rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500">Cancel</button>
                    <button id="confirm-action-btn" class="px-8 py-4 text-lg rounded-lg bg-red-600 text-white hover:bg-red-700">Confirm</button>
                </div>
           </div></div>
        </div>
    </div>
    
    <div id="messageBar" class="fixed bottom-6 right-6 p-5 rounded-xl text-white text-lg shadow-lg opacity-0 transition-opacity duration-300 max-w-md"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'http://localhost:3000/tasks';
            
            // --- STATE MANAGEMENT ---
            let allTasks = [];
            let currentFilter = 'all'; 
            let currentSort = 'created_at'; 

            // --- DOM ELEMENTS ---
            const taskListEl = document.getElementById('taskList');
            const addTaskFormEl = document.getElementById('addTaskForm');
            const loadingIndicatorEl = document.getElementById('loading');
            const editModalEl = document.getElementById('editModal');
            const editFormEl = document.getElementById('editTaskForm');
            const confirmModalEl = document.getElementById('confirmModal');
            const messageBarEl = document.getElementById('messageBar');
            const themeToggleBtn = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            const htmlEl = document.documentElement;
            const filterButtonsEl = document.getElementById('filter-buttons');
            const sortBySelectEl = document.getElementById('sort-by');
            const activeCountEl = document.getElementById('active-count');
            const completedCountEl = document.getElementById('completed-count');
            const clearCompletedBtnEl = document.getElementById('clear-completed-btn');

            // --- THEME ---
            const savedTheme = localStorage.getItem('theme') || 'light';
            htmlEl.classList.add(savedTheme);
            (savedTheme === 'dark' ? lightIcon : darkIcon).classList.remove('hidden');

            themeToggleBtn.addEventListener('click', () => {
                const isDark = htmlEl.classList.toggle('dark');
                htmlEl.classList.toggle('light', !isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                lightIcon.classList.toggle('hidden');
                darkIcon.classList.toggle('hidden');
            });

            // --- UTILITIES ---
            const showMessage = (message, isError = false) => {
                messageBarEl.textContent = message;
                messageBarEl.className = messageBarEl.className.replace(/bg-\w+-\d+/, '');
                messageBarEl.classList.add(isError ? 'bg-red-600' : 'bg-green-600');
                messageBarEl.classList.remove('opacity-0');
                setTimeout(() => messageBarEl.classList.add('opacity-0'), 3000);
            };

            const formatDate = (dateString) => {
                if (!dateString || new Date(dateString).toString() === 'Invalid Date') return null;
                const date = new Date(dateString);
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                const isYesterday = date.toDateString() === new Date(today.getTime() - 86400000).toDateString();
                const day = isToday ? 'Today' : isYesterday ? 'Yesterday' : date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                return `${day}, ${date.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' })}`;
            };
            
            const getDatePillClass = (dateString) => {
                if (!dateString) return '';
                const date = new Date(dateString);
                const today = new Date(); today.setHours(0, 0, 0, 0);
                if (date < today) return 'date-past';
                if (date.toDateString() === today.toDateString()) return 'date-today';
                return 'date-future';
            };
            
            const openModal = (modalEl) => {
                modalEl.classList.remove('invisible', 'opacity-0');
                modalEl.querySelector('.modal-content').classList.remove('scale-95');
            };

            const closeModal = (modalEl) => {
                modalEl.classList.add('opacity-0');
                modalEl.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modalEl.classList.add('invisible'), 300);
            };

            // --- RENDER & DISPLAY LOGIC ---
            const updateStats = () => {
                const completed = allTasks.filter(t => t.completed).length;
                const active = allTasks.length - completed;
                activeCountEl.textContent = active;
                completedCountEl.textContent = completed;
                clearCompletedBtnEl.disabled = completed === 0;
            };

            const renderTasks = () => {
                updateStats();
                let tasksToRender = [...allTasks];
                
                if (currentFilter === 'active') tasksToRender = tasksToRender.filter(t => !t.completed);
                if (currentFilter === 'completed') tasksToRender = tasksToRender.filter(t => t.completed);

                tasksToRender.sort((a, b) => {
                    if (currentSort === 'due_date') {
                        if (!a.due_date) return 1; if (!b.due_date) return -1;
                        return new Date(a.due_date) - new Date(b.due_date);
                    }
                    return new Date(b.created_at) - new Date(a.created_at);
                });

                taskListEl.innerHTML = '';
                if (tasksToRender.length === 0) {
                    taskListEl.innerHTML = `
                        <div class="text-center py-16 glass-card rounded-2xl">
                            <svg class="mx-auto h-20 w-20" style="color: var(--text-secondary);" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            <h3 class="mt-5 text-2xl font-semibold" style="color: var(--text-primary);">All clear!</h3>
                            <p class="mt-2 text-lg" style="color: var(--text-secondary);">Add a task to get started.</p>
                        </div>`;
                    return;
                }

                tasksToRender.forEach(task => {
                    const isCompleted = task.completed === 1;
                    const formattedDate = formatDate(task.due_date);
                    const taskElement = document.createElement('div');
                    taskElement.className = `task-item glass-card rounded-xl p-6 flex items-start space-x-6 ${isCompleted ? 'task-completed opacity-60' : ''}`;
                    taskElement.dataset.taskId = task.id;
                    taskElement.innerHTML = `
                        <input type="checkbox" class="h-8 w-8 rounded-lg border-gray-300 text-indigo-600 focus:ring-indigo-500 mt-1 flex-shrink-0 toggle-complete cursor-pointer" style="background-color: transparent; border-color: var(--border-color);" ${isCompleted ? 'checked' : ''}>
                        <div class="flex-grow"><div class="flex justify-between items-start">
                            <p class="task-title font-semibold text-2xl" style="color: var(--text-primary);">${task.title}</p>
                            ${formattedDate ? `<span class="date-pill ${getDatePillClass(task.due_date)}">${formattedDate}</span>` : ''}
                        </div><p class="task-description mt-2 text-lg" style="color: var(--text-secondary);">${task.description || ''}</p></div>
                        <div class="flex-shrink-0 flex space-x-2">
                            <button class="edit-btn p-3 rounded-full hover:bg-indigo-100 dark:hover:bg-slate-700" title="Edit Task" style="color: var(--text-secondary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button>
                            <button class="delete-btn p-3 rounded-full hover:bg-red-100 dark:hover:bg-slate-700" title="Delete Task" style="color: var(--text-secondary);"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </div>`;
                    taskListEl.appendChild(taskElement);
                });
            };

            // --- API & EVENT HANDLERS ---
            const apiRequest = async (url, options = {}) => {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errData = await response.json().catch(() => ({ error: 'An unknown error occurred' }));
                        throw new Error(errData.details ? errData.details[0].msg : errData.error);
                    }
                    return response.json();
                } catch (error) {
                    showMessage(error.message, true);
                    throw error;
                }
            };
            
            const fetchTasks = async () => {
                loadingIndicatorEl.style.display = 'block';
                try {
                    const result = await apiRequest(API_URL);
                    allTasks = result.data || [];
                    renderTasks();
                } catch (error) {
                    taskListEl.innerHTML = `<div class="text-center text-red-500 py-4">Error loading tasks. Is the backend server running?</div>`;
                } finally {
                    loadingIndicatorEl.style.display = 'none';
                }
            };

            addTaskFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = addTaskFormEl.querySelector('#title').value.trim();
                const description = addTaskFormEl.querySelector('#description').value.trim();
                const due_date = addTaskFormEl.querySelector('#due_date').value;
                if (!title) { showMessage('Title is required.', true); return; }
                const newTask = { title, description };
                if (due_date) { newTask.due_date = new Date(due_date).toISOString(); }
                try {
                    const result = await apiRequest(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newTask) });
                    allTasks.push(result.data);
                    renderTasks();
                    addTaskFormEl.reset();
                    showMessage('Task added successfully!');
                } catch(e) {}
            });

            editFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = editFormEl.querySelector('#edit-id').value;
                const completedStatus = editFormEl.querySelector('#edit-completed-status').value;
                
                const updateData = {
                    title: editFormEl.querySelector('#edit-title').value.trim(),
                    description: editFormEl.querySelector('#edit-description').value.trim(),
                    due_date: editFormEl.querySelector('#edit-due_date').value ? new Date(editFormEl.querySelector('#edit-due_date').value).toISOString() : null,
                    completed: parseInt(completedStatus)
                };
                try {
                    const result = await apiRequest(`${API_URL}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updateData) });
                    const taskIndex = allTasks.findIndex(t => t.id == id);
                    if (taskIndex > -1) allTasks[taskIndex] = result.data;
                    renderTasks();
                    closeModal(editModalEl);
                    showMessage('Task updated successfully!');
                } catch(e) {}
            });
            
            const showConfirmation = (title, message, onConfirm) => {
                confirmModalEl.querySelector('#confirm-title').textContent = title;
                confirmModalEl.querySelector('#confirm-message').textContent = message;
                const confirmBtn = confirmModalEl.querySelector('#confirm-action-btn');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                newConfirmBtn.addEventListener('click', () => { onConfirm(); closeModal(confirmModalEl); });
                openModal(confirmModalEl);
            };

            clearCompletedBtnEl.addEventListener('click', () => {
                showConfirmation('Clear Completed Tasks?', 'This will permanently delete all completed tasks.', async () => {
                    const completedTasks = allTasks.filter(t => t.completed);
                    try {
                       await Promise.all(completedTasks.map(t => apiRequest(`${API_URL}/${t.id}`, { method: 'DELETE' })));
                       allTasks = allTasks.filter(t => !t.completed);
                       renderTasks();
                       showMessage('Completed tasks cleared!');
                    } catch(e){}
                });
            });
            
            taskListEl.addEventListener('click', async (e) => {
                const taskEl = e.target.closest('[data-task-id]');
                if (!taskEl) return;
                const id = taskEl.dataset.taskId;
                const task = allTasks.find(t => t.id == id);
                if (!task) return;

                if (e.target.closest('.toggle-complete')) {
                    try {
                        const result = await apiRequest(`${API_URL}/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ completed: !task.completed }) });
                        task.completed = result.data.completed;
                        renderTasks();
                    } catch(e){}
                } else if (e.target.closest('.edit-btn')) {
                    editFormEl.querySelector('#edit-id').value = task.id;
                    editFormEl.querySelector('#edit-completed-status').value = task.completed;
                    editFormEl.querySelector('#edit-title').value = task.title;
                    editFormEl.querySelector('#edit-description').value = task.description || '';
                    const dateVal = task.due_date ? new Date(new Date(task.due_date).getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16) : '';
                    editFormEl.querySelector('#edit-due_date').value = dateVal;
                    openModal(editModalEl);
                } else if (e.target.closest('.delete-btn')) {
                    showConfirmation('Delete Task?', 'Are you sure you want to permanently delete this task?', async () => {
                        try {
                            await apiRequest(`${API_URL}/${id}`, { method: 'DELETE' });
                            allTasks = allTasks.filter(t => t.id != id);
                            renderTasks();
                            showMessage('Task deleted.');
                        } catch(e) {}
                    });
                }
            });

            document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => {
                closeModal(btn.closest('.modal'));
            }));
            
            filterButtonsEl.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    currentFilter = e.target.dataset.filter;
                    filterButtonsEl.querySelectorAll('button').forEach(btn => {
                        btn.style.backgroundColor = btn.dataset.filter === currentFilter ? 'var(--input-bg)' : 'transparent';
                        btn.style.color = btn.dataset.filter === currentFilter ? 'var(--text-primary)' : 'var(--text-secondary)';
                    });
                    renderTasks();
                }
            });
            
            sortBySelectEl.addEventListener('change', (e) => {
                currentSort = e.target.value;
                renderTasks();
            });

            fetchTasks();
            filterButtonsEl.querySelector('[data-filter="all"]').click();

            // --- Live Background Effect ---
            const blob1 = document.querySelector('.blob-1');
            const blob2 = document.querySelector('.blob-2');

            if (blob1 && blob2) {
                window.addEventListener('mousemove', (event) => {
                    const { clientX, clientY } = event;
                    const { innerWidth, innerHeight } = window;

                    const moveX1 = (clientX / innerWidth) * 50 - 25; // range from -25 to 25
                    const moveY1 = (clientY / innerHeight) * 50 - 25;
                    const moveX2 = (clientX / innerWidth) * -30 + 15;
                    const moveY2 = (clientY / innerHeight) * -30 + 15;

                    requestAnimationFrame(() => {
                        blob1.style.transform = `translate(${moveX1}px, ${moveY1}px)`;
                        blob2.style.transform = `translate(${moveX2}px, ${moveY2}px)`;
                    });
                });
            }
        });
    </script>
</body>
</html>

